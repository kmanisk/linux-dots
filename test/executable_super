
#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# ARCH/HYPRLAND ROFI MENU SYSTEM
# Optimized for Bash 5+ | Dependencies: rofi-wayland, uwsm, kitty, hyprctl, fd, file
# -----------------------------------------------------------------------------

set -uo pipefail

# --- CONFIGURATION ---
readonly SCRIPTS_DIR="${HOME}/user_scripts"
readonly HYPR_CONF="${HOME}/.config/hypr"
readonly HYPR_SOURCE="${HYPR_CONF}/source"
readonly SEARCH_DIR="${HOME}/Documents/pensive/linux"

readonly PROGRAMS_DIR="${HOME}/work"   # <--- location of install.sh & remove.sh

readonly TERMINAL="kitty"
readonly EDITOR="${EDITOR:-nvim}"
readonly FILE_MANAGER="yazi"

readonly ROFI_CMD=(
    rofi 
    -dmenu 
    -i 
    -theme-str 'window {width: 25%;} listview {lines: 12;}'
)

# --- CORE FUNCTIONS ---

menu() {
    local prompt="$1"
    local options="$2"
    local preselect="${3:-}"
    
    local cmd_args=("${ROFI_CMD[@]}" -p "$prompt")

    if [[ -n "$preselect" ]]; then
        local index
        index=$(printf "%b" "$options" | grep -nxF "$preselect" | cut -d: -f1 || true)
        if [[ -n "$index" ]]; then
            cmd_args+=("-selected-row" "$((index - 1))")
        fi
    fi

    printf "%b" "$options" | "${cmd_args[@]}"
}

run_app() {
    uwsm-app -- "$@" >/dev/null 2>&1 &
    disown
    exit 0
}

run_term_hold() {
    local title="$1"
    shift
    # Use --title for kitty on Wayland (--class doesn't work)
    uwsm-app -- "$TERMINAL" --title "$title" --hold -e bash "$@" >/dev/null 2>&1 &
    disown
    exit 0
}

run_term() {
    local title="$1"
    shift
    uwsm-app -- "$TERMINAL" --title "$title" -e "$@" >/dev/null 2>&1 &
    disown
    exit 0
}

open_editor() {
    local file="$1"
    uwsm-app -- "$TERMINAL" --title "nvim_config" -e "$EDITOR" "$file" >/dev/null 2>&1 &
    disown
    exit 0
}

# --- MENUS ---

show_main_menu() {
    local selection
    selection=$(menu "Main" "ðŸ”  Search Notes\nó°€»  Apps\nó°§‘  Learn/Help\nó±“ž  Utils\nó±š¤  AI & Voice\nó°¹‘  Visuals & Display\nó°‡…  System & Drives\nó±‹  Performance\nó°‚„  Power & Battery\nó°›³  Networking\n  Configs\nó°‰  Power\nðŸ–¥ï¸  Programs")
    
    route_selection "$selection"
}

route_selection() {
    local choice="${1,,}"

    case "$choice" in
        *search*)      perform_global_search ;;
        *apps*)        run_app rofi -show drun -run-command "uwsm app -- {cmd}" ;; 
        *learn*)       show_learn_menu ;;
        *utils*)       show_utils_menu ;;
        *ai*)          show_ai_menu ;;
        *visuals*)     show_visuals_menu ;;
        *system*)      show_system_menu ;;
        *performance*) show_performance_menu ;;
        *battery*)     show_power_battery_menu ;;
        *network*)     show_networking_menu ;;
        *configs*)     show_config_menu ;;
        *power*)       run_app rofi -show power-menu -modi "power-menu:$SCRIPTS_DIR/rofi/powermenu.sh" ;;
        *programs*)    show_programs_menu ;;
        *)             exit 0 ;;
    esac
}

# --- SEARCH LOGIC ---

perform_global_search() {
    local selected_relative
    local full_path
    local search_output

    if command -v fd >/dev/null 2>&1; then
        search_output=$(cd "${SEARCH_DIR}" && fd --type f --hidden --exclude .git .)
    else
        search_output=$(cd "${SEARCH_DIR}" && find . -type f -not -path '*/.*' | sed 's|^\./||')
    fi

    selected_relative=$(printf "%s\n" "$search_output" | "${ROFI_CMD[@]}" -theme-str 'window {width: 80%;}' -p "Search")

    if [[ -n "$selected_relative" ]]; then
        full_path="${SEARCH_DIR}/${selected_relative}"

        if [[ -d "$full_path" ]]; then
            run_term "yazi_filemanager" "$FILE_MANAGER" "$full_path"
        fi

        local mime_type
        mime_type=$(file --mime-type -b "$full_path")

        case "$mime_type" in
            text/*|application/json|application/x-shellscript|application/toml|application/x-yaml|application/xml|application/x-conf|application/x-config)
                open_editor "$full_path"
                ;;
            inode/x-empty)
                open_editor "$full_path"
                ;;
            *)
                uwsm-app -- xdg-open "$full_path" >/dev/null 2>&1 &
                disown
                exit 0
                ;;
        esac
    else
        show_main_menu
    fi
}

# --- PROGRAMS MENU (FIXED FOR FLOATING WINDOWS) ---
show_programs_menu() {
    local choice
    choice=$(menu "Programs" "  Install Packages\nðŸ—‘ï¸  Remove Packages")
    
    case "${choice,,}" in
        *install*) 
            hyprctl dispatch exec "[float;size 60% 70%;center] $TERMINAL --title 'Install Packages' -e bash -c '$PROGRAMS_DIR/install; read -n 1 -s -r -p \"Press any key to close...\"'" >/dev/null 2>&1
            exit 0
            ;;
        *remove*)  
            hyprctl dispatch exec "[float;size 60% 70%;center] $TERMINAL --title 'Remove Packages' -e bash -c '$PROGRAMS_DIR/remove; read -n 1 -s -r -p \"Press any key to close...\"'" >/dev/null 2>&1
            exit 0
            ;;
        *)         
            show_main_menu 
            ;;
    esac
}
# --- OTHER MENUS ---
# Add your existing menu functions below (show_learn_menu, show_ai_menu, etc.)
# I'm including placeholder versions - replace with your actual implementations

show_learn_menu() {
    local choice
    choice=$(menu "Learn/Help" "ðŸ“š  Arch Wiki\nðŸ“–  Man Pages\n  Hyprland Docs\n  Back")
    
    case "${choice,,}" in
        *arch*)   run_app firefox "https://wiki.archlinux.org" ;;
        *man*)    run_term "man_pages" bash -c 'man -k . | fzf | awk "{print \$1}" | xargs -r man' ;;
        *hypr*)   run_app firefox "https://wiki.hyprland.org" ;;
        *back*)   show_main_menu ;;
        *)        exit 0 ;;
    esac
}

show_utils_menu() {
    local choice
    choice=$(menu "Utils" "  Calculator\n  Screenshot\n  Color Picker\n  Back")
    
    case "${choice,,}" in
        *calc*)   run_term "calculator" python -q ;;
        *screen*) run_app grimblast --freeze copy area ;;
        *color*)  run_app hyprpicker -a ;;
        *back*)   show_main_menu ;;
        *)        exit 0 ;;
    esac
}

show_ai_menu() {
    local choice
    choice=$(menu "AI & Voice" "  ChatGPT\n  Claude AI\n  Voice Control\n  Back")
    
    case "${choice,,}" in
        *chat*)   run_app firefox "https://chat.openai.com" ;;
        *claude*) run_app firefox "https://claude.ai" ;;
        *voice*)  run_term "voice_control" bash -c 'echo "Voice control not configured"' ;;
        *back*)   show_main_menu ;;
        *)        exit 0 ;;
    esac
}

show_visuals_menu() {
    local choice
    choice=$(menu "Visuals & Display" "  Monitor Settings\n  Wallpaper\n  Theme\n  Back")
    
    case "${choice,,}" in
        *monitor*) run_app wdisplays ;;
        *wall*)    run_term "wallpaper" bash -c 'echo "Wallpaper selector not configured"' ;;
        *theme*)   run_term "theme" bash -c 'echo "Theme selector not configured"' ;;
        *back*)    show_main_menu ;;
        *)         exit 0 ;;
    esac
}

show_system_menu() {
    local choice
    choice=$(menu "System & Drives" "  Disk Usage\n  Mount Drives\n  System Info\n  Back")
    
    case "${choice,,}" in
        *disk*)   run_term "disk_usage" ncdu / ;;
        *mount*)  run_term "mount_drives" bash -c 'lsblk; read -p "Press enter to close"' ;;
        *info*)   run_term "system_info" neofetch ;;
        *back*)   show_main_menu ;;
        *)        exit 0 ;;
    esac
}

show_performance_menu() {
    local choice
    choice=$(menu "Performance" "  System Monitor\n  Process Manager\n  CPU Info\n  Back")
    
    case "${choice,,}" in
        *monitor*) run_term "system_monitor" btop ;;
        *process*) run_term "process_manager" htop ;;
        *cpu*)     run_term "cpu_info" bash -c 'lscpu; read -p "Press enter to close"' ;;
        *back*)    show_main_menu ;;
        *)         exit 0 ;;
    esac
}

show_power_battery_menu() {
    local choice
    choice=$(menu "Power & Battery" "  Battery Info\n  Power Profile\n  Back")
    
    case "${choice,,}" in
        *battery*) run_term "battery_info" bash -c 'upower -i /org/freedesktop/UPower/devices/battery_BAT0; read -p "Press enter to close"' ;;
        *profile*) run_term "power_profile" bash -c 'powerprofilesctl list; read -p "Press enter to close"' ;;
        *back*)    show_main_menu ;;
        *)         exit 0 ;;
    esac
}

show_networking_menu() {
    local choice
    choice=$(menu "Networking" "  WiFi Manager\n  Network Info\n  Speed Test\n  Back")
    
    case "${choice,,}" in
        *wifi*)   run_app nmtui ;;
        *info*)   run_term "network_info" bash -c 'ip a; read -p "Press enter to close"' ;;
        *speed*)  run_term "speed_test" bash -c 'speedtest; read -p "Press enter to close"' ;;
        *back*)   show_main_menu ;;
        *)        exit 0 ;;
    esac
}

show_config_menu() {
    local choice
    choice=$(menu "Configs" "  Hyprland Config\n  Kitty Config\n  Rofi Config\n  Back")
    
    case "${choice,,}" in
        *hypr*)  open_editor "${HYPR_CONF}/hyprland.conf" ;;
        *kitty*) open_editor "${HOME}/.config/kitty/kitty.conf" ;;
        *rofi*)  open_editor "${HOME}/.config/rofi/config.rasi" ;;
        *back*)  show_main_menu ;;
        *)       exit 0 ;;
    esac
}

# --- ENTRY POINT ---

if [[ -n "${1:-}" ]]; then
    route_selection "$1"
else
    show_main_menu
fi
